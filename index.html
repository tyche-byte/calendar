<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>구글 캘린더 다년도 대시보드</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap');
        body { font-family: 'Pretendard', sans-serif; background-color: #f8fafc; }
        .holiday-row { background-color: #fef2f2; color: #ef4444; font-weight: 600; }
        .tab-active { border-bottom: 3px solid #3b82f6; color: #3b82f6; }
        .loader { border-top-color: #3498db; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #password_overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #ffffff; z-index: 9999; display: flex;
            align-items: center; justify-content: center;
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Password Protection Overlay -->
    <div id="password_overlay">
        <div class="max-w-md w-full p-8 bg-white rounded-2xl shadow-xl border border-gray-100 text-center">
            <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fa-solid fa-lock text-2xl"></i>
            </div>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">보안 접속</h2>
            <p class="text-gray-500 mb-6">대시보드 접속을 위해 비밀번호를 입력하세요.</p>
            <input type="password" id="access_password" class="w-full px-4 py-3 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="비밀번호 입력">
            <button onclick="checkPassword()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition">확인</button>
            <p id="password_error" class="text-red-500 text-sm mt-3 hidden">비밀번호가 올바르지 않습니다.</p>
        </div>
    </div>

    <!-- Main Content -->
    <div id="main_content" style="display: none;">
        <header class="bg-white shadow-sm sticky top-0 z-50">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
                <h1 class="text-xl font-bold text-gray-800 flex items-center">
                    <i class="fa-solid fa-calendar-days text-blue-600 mr-2"></i>
                    Calendar Dashboard (2026-2030)
                </h1>
                <div class="flex items-center space-x-3">
                    <button onclick="refreshCurrentYear()" class="text-gray-500 hover:text-blue-600 p-2 transition" title="새로고침">
                        <i class="fa-solid fa-rotate"></i>
                    </button>
                    <div id="auth_buttons">
                        <button id="authorize_button" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-semibold transition" style="display: none;">구글 로그인</button>
                        <button id="signout_button" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg text-sm font-semibold transition" style="display: none;">로그아웃</button>
                    </div>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="flex space-x-4 mb-6 border-b border-gray-200 overflow-x-auto" id="year_tabs">
                <button onclick="changeYear('2026')" class="tab-btn px-6 py-3 font-semibold text-gray-500 hover:text-blue-600 transition" id="tab_2026">2026</button>
                <button onclick="changeYear('2027')" class="tab-btn px-6 py-3 font-semibold text-gray-500 hover:text-blue-600 transition" id="tab_2027">2027</button>
                <button onclick="changeYear('2028')" class="tab-btn px-6 py-3 font-semibold text-gray-500 hover:text-blue-600 transition" id="tab_2028">2028</button>
                <button onclick="changeYear('2029')" class="tab-btn px-6 py-3 font-semibold text-gray-500 hover:text-blue-600 transition" id="tab_2029">2029</button>
                <button onclick="changeYear('2030')" class="tab-btn px-6 py-3 font-semibold text-gray-500 hover:text-blue-600 transition" id="tab_2030">2030</button>
            </div>

            <div id="content_display" class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                <div id="loading_overlay" class="p-20 flex flex-col items-center justify-center hidden">
                    <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4"></div>
                    <p class="text-gray-500">일정을 불러오는 중입니다...</p>
                </div>
                <div id="empty_state" class="p-20 flex flex-col items-center justify-center">
                    <i class="fa-solid fa-lock text-gray-300 text-6xl mb-4"></i>
                    <p class="text-gray-500 text-lg">데이터를 보려면 구글 계정으로 로그인하세요.</p>
                    <p class="text-gray-400 text-sm mt-2">로그인 시 '모든 캘린더 보기' 권한에 꼭 체크해 주세요.</p>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 hidden" id="event_table">
                        <thead class="bg-blue-600">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-bold text-white uppercase tracking-wider">출처</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-white uppercase tracking-wider">일정명</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-white uppercase tracking-wider">날짜</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-white uppercase tracking-wider">시작</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-white uppercase tracking-wider">종료</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-white uppercase tracking-wider">종일</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-white uppercase tracking-wider">장소</th>
                            </tr>
                        </thead>
                        <tbody id="event_list" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
        /* --- 핵심 설정 --- */
        const CLIENT_ID = '587183038273-n6tf599jh3koqc168ns19p7uv6l12d9o.apps.googleusercontent.com'; 
        const API_KEY = 'AIzaSyBIfIR84-XXE0fN0GzMvsl8pSMqfgLnd9Y'; 
        const DASHBOARD_PASSWORD = '1234'; 

        const HOLIDAY_CAL_ID = "ko.south_korea#holiday@group.v.calendar.google.com";
        let tokenClient, gapiInited = false, gisInited = false, currentYear = "2026", cachedData = {};

        function checkPassword() {
            const input = document.getElementById('access_password').value;
            if (input === DASHBOARD_PASSWORD) {
                document.getElementById('password_overlay').style.display = 'none';
                document.getElementById('main_content').style.display = 'block';
                loadScripts();
            } else {
                document.getElementById('password_error').classList.remove('hidden');
            }
        }

        function loadScripts() {
            const s1 = document.createElement('script');
            s1.src = "https://apis.google.com/js/api.js";
            s1.onload = () => gapi.load('client', initGapi);
            document.body.appendChild(s1);

            const s2 = document.createElement('script');
            s2.src = "https://accounts.google.com/gsi/client";
            s2.onload = initGis;
            document.body.appendChild(s2);
        }

        async function initGapi() {
            await gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest']
            });
            gapiInited = true;
            maybeEnableButtons();
        }

        function initGis() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: 'https://www.googleapis.com/auth/calendar.readonly',
                callback: ''
            });
            gisInited = true;
            maybeEnableButtons();
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited) document.getElementById('authorize_button').style.display = 'block';
        }

        document.getElementById('authorize_button').onclick = () => {
            tokenClient.callback = (resp) => {
                if (resp.error) return;
                document.getElementById('authorize_button').style.display = 'none';
                document.getElementById('signout_button').style.display = 'block';
                document.getElementById('empty_state').style.display = 'none';
                changeYear(currentYear);
            };
            tokenClient.requestAccessToken({prompt: 'consent'});
        };

        async function changeYear(year) {
            currentYear = year;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('tab-active'));
            const tab = document.getElementById(`tab_${year}`);
            if (tab) tab.classList.add('tab-active');
            if (gapi.client.getToken()) {
                if (cachedData[year]) renderEvents(cachedData[year]);
                else fetchEvents(year);
            }
        }

        async function fetchEvents(year) {
            document.getElementById('loading_overlay').classList.remove('hidden');
            document.getElementById('event_table').classList.add('hidden');
            
            const tMin = `${year}-01-01T00:00:00Z`;
            const tMax = `${year}-12-31T23:59:59Z`;

            try {
                // 1. 캘린더 리스트 가져오기
                const calendarListRes = await gapi.client.calendar.calendarList.list();
                const calendarItems = calendarListRes.result.items || [];
                
                // 2. 캘린더 ID 세트 구성 (중복 방지)
                const calendarIds = new Set();
                calendarIds.add('primary'); // 기본 캘린더 강제 포함
                calendarItems.forEach(cal => calendarIds.add(cal.id));
                calendarIds.add(HOLIDAY_CAL_ID); // 공휴일 캘린더

                // 3. 병렬 요청 생성
                const fetchPromises = Array.from(calendarIds).map(id => {
                    return new Promise((resolve) => {
                        gapi.client.calendar.events.list({
                            calendarId: id,
                            timeMin: tMin,
                            timeMax: tMax,
                            singleEvents: true,
                            orderBy: 'startTime'
                        }).then(
                            resp => {
                                // 캘린더 이름 찾기
                                let calName = (id === 'primary') ? "기본" : (id === HOLIDAY_CAL_ID ? "휴일" : "일정");
                                const match = calendarItems.find(c => c.id === id);
                                if (match) calName = match.summary;
                                resolve({ calName, items: resp.result.items || [] });
                            },
                            err => {
                                console.warn(`${id} 로드 실패:`, err);
                                resolve({ calName: "오류", items: [] });
                            }
                        );
                    });
                });

                const allResults = await Promise.all(fetchPromises);

                const data = [];
                const ys = new Date(year + "-01-01T00:00:00");
                const ye = new Date(year + "-12-31T23:59:59");

                allResults.forEach(res => {
                    res.items.forEach(e => {
                        // 근무 위치 정보나 제목 없는 시스템 일정 제외
                        if (!e.summary || e.summary === "사무실" || e.eventType === 'workingLocation') return;
                        
                        let start = new Date(e.start.dateTime || e.start.date);
                        let end = new Date(e.end.dateTime || e.end.date);
                        
                        // 기간 내에 포함되는지 확인 및 다중일 처리
                        let cur = new Date(start);
                        // 종료 시간이 시작 시간과 같으면 최소 1분이라도 있게 설정 (반복문 보장)
                        if (start.getTime() === end.getTime()) end.setMinutes(end.getMinutes() + 1);

                        while (cur < end) {
                            if (cur >= ys && cur <= ye) {
                                data.push({
                                    calendarName: res.calName,
                                    title: e.summary,
                                    date: cur.toISOString().split('T')[0],
                                    start: !e.start.dateTime ? "종일" : cur.toTimeString().slice(0, 5),
                                    end: !e.end.dateTime ? "종일" : end.toTimeString().slice(0, 5),
                                    isAllDay: !e.start.dateTime ? "O" : "X",
                                    loc: e.location || "-"
                                });
                            }
                            cur.setDate(cur.getDate() + 1);
                            cur.setHours(0, 0, 0, 0);
                        }
                    });
                });

                // 중복 제거 (여러 캘린더에 같은 일정이 있을 경우 대비)
                const uniqueData = Array.from(new Set(data.map(a => JSON.stringify(a)))).map(a => JSON.parse(a));
                uniqueData.sort((a, b) => new Date(a.date) - new Date(b.date));
                
                cachedData[year] = uniqueData;
                renderEvents(uniqueData);

            } catch (err) {
                console.error(err);
                const msg = err.result?.error?.message || "데이터 로드 중 오류가 발생했습니다.";
                document.getElementById('event_list').innerHTML = `<tr><td colspan="7" class="p-10 text-center text-red-500 font-bold">에러: ${msg}</td></tr>`;
                document.getElementById('event_table').classList.remove('hidden');
            } finally {
                document.getElementById('loading_overlay').classList.add('hidden');
            }
        }

        function renderEvents(evs) {
            const list = document.getElementById('event_list');
            if (!evs.length) {
                list.innerHTML = '<tr><td colspan="7" class="p-10 text-center text-gray-500 font-medium">표시할 일정이 없습니다.<br><span class="text-xs text-gray-400 mt-2">입력한 일정이 있다면 로그아웃 후 다시 로그인하며 권한을 모두 승인해 보세요.</span></td></tr>';
            } else {
                list.innerHTML = evs.map(ev => `
                    <tr class="${ev.calendarName === '휴일' ? 'holiday-row' : ''} hover:bg-gray-50 transition">
                        <td class="px-6 py-4 text-[10px] text-gray-400 font-bold">${ev.calendarName}</td>
                        <td class="px-6 py-4 font-semibold text-gray-800">${ev.title}</td>
                        <td class="px-6 py-4 text-sm text-gray-600">${ev.date}</td>
                        <td class="px-6 py-4 text-sm text-gray-500">${ev.start}</td>
                        <td class="px-6 py-4 text-sm text-gray-500">${ev.end}</td>
                        <td class="px-6 py-4 text-sm text-center text-gray-500">${ev.isAllDay}</td>
                        <td class="px-6 py-4 truncate max-w-xs text-xs text-gray-400">${ev.loc}</td>
                    </tr>
                `).join('');
            }
            document.getElementById('event_table').classList.remove('hidden');
        }

        function refreshCurrentYear() {
            delete cachedData[currentYear];
            fetchEvents(currentYear);
        }
    </script>
</body>
</html>
